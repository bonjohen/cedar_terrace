# SQLite Migration Progress

## Completed

âœ… **Package.json**: Replaced `pg` and `@types/pg` with `better-sqlite3` and `@types/better-sqlite3`

âœ… **Connection Layer** (`src/db/connection.ts`):
- Replaced Pool-based connection with SQLite database connection
- Added database file path management (data/cedar_terrace.db)
- Enabled foreign keys, WAL mode, and optimized pragmas
- Added transaction helper function

âœ… **Schema Migration** (`src/db/migrations/001_initial_schema.sql`):
- Converted PostgreSQL UUID to SQLite TEXT with UUID generation expressions
- Converted PostgreSQL TIMESTAMP WITH TIME ZONE to TEXT with datetime functions
- Converted PostgreSQL BOOLEAN to INTEGER (0/1)
- Converted PostgreSQL ENUM types to TEXT with CHECK constraints
- Converted PostgreSQL NUMERIC to REAL
- Converted PostgreSQL JSONB to TEXT
- Updated all triggers to SQLite syntax
- Added IF NOT EXISTS clauses for idempotency

âœ… **Migrator** (`src/db/migrator.ts`):
- Replaced Pool with Database
- Converted async methods to synchronous (SQLite is synchronous)
- Updated query syntax from parameterized ($1) to prepared statements (?)
- Used transactions for migration safety

âœ… **Migration Script** (`scripts/migrate.js`):
- Updated to use better-sqlite3
- Added data directory creation
- Enabled foreign keys pragma

âœ… **Parking Position Service** (`src/domain/parking-position.ts`):
- Replaced Pool with Database
- Converted all async methods to sync
- Updated query parameterization ($1, $2 â†’ ?)
- Added UUID generation with uuid v4
- Updated result handling (pool.query â†’ db.prepare().run/get/all)
- Fixed SQRT distance calculation to SQLite-compatible formula

## In Progress

ðŸ”„ **Domain Services** - Need to update remaining services:
- [ ] `src/domain/observation.ts`
- [ ] `src/domain/violation.ts`
- [ ] `src/domain/notice.ts`
- [ ] `src/domain/recipient.ts`
- [ ] `src/domain/handicapped.ts`

ðŸ”„ **API Routes** - Need to update all route files:
- [ ] `src/api/parking-positions.ts` - Update Pool â†’ Database imports and initialization
- [ ] `src/api/observations.ts`
- [ ] `src/api/violations.ts`
- [ ] `src/api/notices.ts`
- [ ] `src/api/recipients.ts`
- [ ] `src/api/storage.ts`
- [ ] `src/api/index.ts` - Update main router initialization

## Pending

ðŸ“‹ **Application Entry Point**:
- [ ] `src/index.ts` - Replace Pool initialization with Database

ðŸ“‹ **Database Utilities**:
- [ ] `src/db/index.ts` - Update exports
- [ ] `src/db/seed.ts` - Update to use Database instead of Pool

ðŸ“‹ **Scripts**:
- [ ] `scripts/seed.js` - Update to use Database

ðŸ“‹ **Tests**:
- [ ] Update all `*.test.ts` files to use SQLite
- [ ] Remove PostgreSQL test setup/teardown
- [ ] Use in-memory SQLite for tests (`:memory:`)

ðŸ“‹ **Documentation**:
- [ ] Update `docs/project/architecture.md` - Remove PostgreSQL references, add SQLite
- [ ] Update `docs/project/design.md` - Update data persistence section
- [ ] Update `GETTING_STARTED.md` - Remove PostgreSQL setup steps
- [ ] Update `LOCAL_DEVELOPMENT.md` - Remove Docker Postgres instructions

ðŸ“‹ **Configuration**:
- [ ] Update `.env.local.example` - Replace DATABASE_URL with DATABASE_PATH
- [ ] Update `local/docker-compose.yml` - Remove postgres service
- [ ] Update `.gitignore` - Add `data/` directory with database files
- [ ] Create `data/.gitkeep` to preserve directory structure

## Migration Strategy

### For Each Domain Service:
1. Import `Database` from 'better-sqlite3' instead of `Pool` from 'pg'
2. Import `{ v4 as uuidv4 }` from 'uuid' for ID generation
3. Change constructor parameter from `Pool` to `Database.Database`
4. Convert all `async` methods to sync (remove `async`/`await`)
5. Replace `pool.query<T>(sql, [params])` with:
   - `db.prepare(sql).run(...params)` for INSERT/UPDATE/DELETE
   - `db.prepare(sql).get(...params)` for single row SELECT
   - `db.prepare(sql).all(...params)` for multi-row SELECT
6. Replace parameterized queries `$1, $2, $3` with `?, ?, ?`
7. Replace `result.rows[0]` with direct result from `.get()`
8. Replace `result.rows` with `.all()` result
9. Replace `result.rowCount` with `result.changes`
10. Generate UUIDs manually with `uuidv4()` instead of database default
11. Use `datetime('now')` for current timestamps instead of CURRENT_TIMESTAMP

### For Each API Route:
1. Import `Database` from 'better-sqlite3' instead of `Pool` from 'pg'
2. Change function parameter from `pool: Pool` to `db: Database.Database`
3. Remove `async` from route handlers if service methods are now sync
4. Pass `db` to service constructors instead of `pool`

## Key Differences: PostgreSQL vs SQLite

| Feature | PostgreSQL | SQLite |
|---------|-----------|--------|
| Connection | Pool (async) | Database (sync) |
| UUID | Generated by DB | Generated in code |
| Timestamps | TIMESTAMP WITH TIME ZONE | TEXT (ISO 8601) |
| Boolean | BOOLEAN | INTEGER (0/1) |
| Enums | ENUM type | TEXT + CHECK constraint |
| JSONB | Native JSONB | TEXT (JSON string) |
| Arrays | Native arrays | TEXT or separate tables |
| Transactions | BEGIN/COMMIT (async) | transaction() wrapper (sync) |
| Parameterization | $1, $2, $3 | ?, ?, ? |
| Multiple statements | Supported in query() | Use db.exec() |

## Testing Strategy

1. Use in-memory database for unit tests: `new Database(':memory:')`
2. Run migrations before each test suite
3. Reset database state between tests
4. No Docker or external services needed

## Deployment Considerations

- SQLite database file: `data/cedar_terrace.db`
- WAL files: `data/cedar_terrace.db-wal`, `data/cedar_terrace.db-shm`
- Backup strategy: Copy database file (while respecting WAL mode)
- Single writer: Ensure only one process writes at a time
- Read scalability: Multiple readers supported with WAL mode
